# Contributing to rspack-plugin-svg-sprite

Thanks for your interest in contributing! This guide covers how to set up the project locally, run tests, and submit changes.

## Prerequisites

- [Node.js](https://nodejs.org/) >= 22
- [pnpm](https://pnpm.io/) >= 10

## Getting Started

```bash
git clone https://github.com/yichenzhu1337/rspack-plugin-svg-sprite.git
cd rspack-plugin-svg-sprite
pnpm install
```

This installs dependencies for the plugin and both example apps via [pnpm workspaces](https://pnpm.io/workspaces).

## Project Structure

```
rspack-plugin-svg-sprite/
├── src/                      # TypeScript source
│   ├── index.ts              # Package entry — re-exports SvgSpritePlugin
│   ├── loader.ts             # Rspack-compatible SVG loader
│   ├── plugin.ts             # SvgSpritePlugin (extract mode asset emission)
│   ├── runtime/
│   │   ├── browser-sprite.ts # Browser-side sprite manager (inline mode)
│   │   └── symbol.ts         # SpriteSymbol class
│   └── __tests__/            # Unit tests (rstest / Jest-compatible API)
├── dist/                     # Compiled JS output (generated by pnpm build)
├── examples/
│   ├── react-rspack/         # React + Rspack demo — uses this plugin
│   └── react-webpack/        # React + Webpack demo — uses svg-sprite-loader (for comparison)
├── tsconfig.json             # TypeScript config (strict, CommonJS output)
├── rstest.config.ts          # Test runner config with Istanbul coverage
├── eslint.config.mjs         # ESLint flat config (typescript-eslint + prettier)
├── .prettierrc               # Prettier config (single quotes, trailing commas, 100 char width)
└── pnpm-workspace.yaml       # Workspace: examples/*
```

## Commands

| Command            | Description                                                |
| ------------------ | ---------------------------------------------------------- |
| `pnpm build`       | Compile TypeScript to `dist/`                              |
| `pnpm test`        | Build + run unit tests                                     |
| `pnpm test:ci`     | Build + run tests with Istanbul coverage (95% threshold)   |
| `pnpm typecheck`   | Type-check without emitting                                |
| `pnpm lint`        | Run ESLint on `src/`                                       |
| `pnpm format`      | Auto-format everything with Prettier                       |
| `pnpm dev:rspack`  | Start the React + Rspack example on http://localhost:3000  |
| `pnpm dev:webpack` | Start the React + Webpack example on http://localhost:4000 |

## Development Workflow

1. Create a branch from `main`.
2. Make your changes in `src/`.
3. Run `pnpm build` to compile.
4. Run `pnpm test` to verify nothing is broken.
5. Run `pnpm lint` and `pnpm format` to catch style issues.
6. Test against the examples with `pnpm dev:rspack`.
7. Commit using [Conventional Commits](https://www.conventionalcommits.org/) (`feat:`, `fix:`, `chore:`, etc.) — semantic-release uses these to determine version bumps.
8. The pre-commit hook (husky + lint-staged) runs ESLint and Prettier automatically on staged files.
9. Open a pull request against `main`.

## How the Plugin Works

### Inline mode (default)

The loader parses each `.svg` file, wraps its content in a `<symbol>`, and generates a JS module that imports the browser-side sprite manager (`runtime/browser-sprite.ts`). At runtime, a hidden `<svg>` element is created in `document.body` and all symbols are appended to it. Icons are referenced via `<use xlink:href="#symbolId" />`.

### Extract mode

The loader registers each symbol with the `SvgSpritePlugin` via the compilation object. During the `processAssets` hook, the plugin collects all symbols and emits a combined `.svg` sprite file. The exported JS module contains the external URL (`sprite.svg#symbolId`) instead of a fragment-only reference.

## Testing

Tests use [rstest](https://rstest.rs) with a Jest-compatible API (`describe`, `it`, `expect`). Each source module has a corresponding test file in `src/__tests__/`.

```bash
pnpm test       # Build + run tests
pnpm test:ci    # Build + run tests with Istanbul coverage report
```

Coverage thresholds are enforced at **95%** for statements, branches, functions, and lines. Coverage reports are generated in `coverage/` (HTML + LCOV) and uploaded to [Codecov](https://codecov.io/gh/yichenzhu1337/rspack-plugin-svg-sprite) on every CI run.

## Code Style

- **TypeScript** with `strict: true` — source in `src/`, compiled output in `dist/`.
- **Prettier** handles formatting — single quotes, trailing commas, 100 char print width, LF line endings.
- **ESLint** with `typescript-eslint` and `eslint-config-prettier` catches common issues.
- **Pre-commit hook** via husky + lint-staged runs both automatically on staged `.ts`/`.tsx` files.
- Keep the public API compatible with `svg-sprite-loader` — the exported symbol object should have the same shape (`id`, `viewBox`, `url`, `content`).
