# AGENTS.md

## Project Overview

`rspack-plugin-svg-sprite` is an Rspack loader and plugin for creating SVG sprites — a drop-in replacement for `svg-sprite-loader` that works natively with Rspack. It was created to solve [rspack#11609](https://github.com/web-infra-dev/rspack/issues/11609).

The plugin supports two modes:

- **Inline mode** (default) — SVG symbols are injected into the DOM at runtime via a hidden `<svg>` element.
- **Extract mode** — SVG symbols are emitted as an external `.svg` sprite file.

## Repository Structure

```
├── src/                          # TypeScript source (compiled to dist/)
│   ├── index.ts                  # Package entry — re-exports SvgSpritePlugin
│   ├── loader.ts                 # Rspack-compatible SVG loader
│   ├── plugin.ts                 # SvgSpritePlugin (extract mode asset emission)
│   ├── runtime/
│   │   ├── browser-sprite.ts     # Browser-side sprite manager (inline mode)
│   │   └── symbol.ts             # SpriteSymbol class
│   └── __tests__/                # Unit tests (rstest, Jest-compatible API)
├── examples/
│   ├── react-rspack/             # React + Rspack demo (port 3000)
│   └── react-webpack/            # React + Webpack + svg-sprite-loader comparison (port 4000)
├── dist/                         # Compiled JS output (git-ignored, generated by `pnpm build`)
├── tsconfig.json                 # TypeScript config — strict, CommonJS output, ES2020 target
├── rstest.config.ts              # Test runner config with Istanbul coverage
├── eslint.config.mjs             # Flat ESLint config with typescript-eslint + prettier
├── .prettierrc                   # Single quotes, trailing commas, 100 char width, LF
├── .lintstagedrc.json            # Pre-commit: eslint --fix + prettier on staged .ts/.tsx files
├── codecov.yml                   # Coverage targets: 80% project, 80% patch
├── pnpm-workspace.yaml           # Workspace members: examples/*
└── .github/workflows/ci.yml      # CI: lint, test, build-examples, semantic-release
```

## Architecture

### How the loader works (`src/loader.ts`)

1. Receives raw SVG file content from Rspack.
2. Parses `viewBox`, extracts inner SVG content, and collects attributes.
3. Wraps content into a `<symbol id="...">` element.
4. **Inline mode**: generates JS that imports `runtime/browser-sprite` and registers the symbol.
5. **Extract mode**: registers the symbol with `SvgSpritePlugin` via `this._compilation[NAMESPACE]`, generates JS that exports a `SpriteSymbol` with the external URL.

### How the plugin works (`src/plugin.ts`)

1. Hooks into `thisCompilation` to attach itself to the compilation object.
2. During `processAssets`, collects all registered symbols grouped by `spriteFilename`.
3. Generates a combined SVG sprite with `<defs>`, `:target` CSS for browser preview, and `<use>` elements.
4. Emits the sprite file via `compilation.emitAsset()`.
5. Uses `compiler.rspack.sources.RawSource` when available, falls back to `webpack-sources` or a built-in `FallbackRawSource`.

### Runtime modules (`src/runtime/`)

- **`symbol.ts`**: `SpriteSymbol` class — holds `id`, `viewBox`, `content`, and a `url` getter/setter. The `url` defaults to `#id` (inline) but can be overridden to an external path (extract).
- **`browser-sprite.ts`**: Auto-mounts a hidden `<svg>` into `document.body` on DOMContentLoaded, appends `<symbol>` elements as they are registered.

### Exported symbol shape (public API)

The object exported by `import icon from './icon.svg'` has these properties:

- `id: string` — the symbol ID
- `viewBox: string` — the SVG viewBox
- `url: string` — `#id` (inline) or `/path/sprite.svg#id` (extract)
- `content: string` — the raw `<symbol>` markup
  This matches `svg-sprite-loader`'s export shape for drop-in compatibility.

## Development Commands

```bash
pnpm build          # Compile TypeScript to dist/
pnpm test           # Build + run tests
pnpm test:ci        # Build + run tests with Istanbul coverage
pnpm typecheck      # Type-check without emitting
pnpm lint           # ESLint on src/
pnpm format         # Prettier format everything
pnpm dev:rspack     # Start react-rspack example on :3000
pnpm dev:webpack    # Start react-webpack example on :4000
```

## Code Conventions

- **Language**: TypeScript with `strict: true`. Source in `src/`, compiled output in `dist/`.
- **Module format**: CommonJS output (`"module": "CommonJS"` in tsconfig). The loader and plugin must work in Node.js CommonJS contexts since Rspack/Webpack configs use `require()`.
- **Formatting**: Prettier — single quotes, trailing commas, 100 char print width, LF line endings.
- **Linting**: ESLint flat config with `typescript-eslint` and `eslint-config-prettier`. `@typescript-eslint/no-explicit-any` is intentionally off because loader/plugin contexts use `any` for Rspack/Webpack interop.
- **Tests**: rstest (Jest-compatible API). Test files live in `src/__tests__/`. Coverage thresholds: 95% across statements, branches, functions, lines.
- **Commits**: Follow [Conventional Commits](https://www.conventionalcommits.org/) — `feat:`, `fix:`, `chore:`, etc. Semantic-release uses these to determine version bumps.
- **Pre-commit**: husky + lint-staged runs `eslint --fix` and `prettier --write` on staged `.ts`/`.tsx` files.
- **No `@typescript-eslint/no-require-imports`**: Turned off because the generated loader runtime uses `require()` for CommonJS interop with Rspack.

## Key Design Decisions

1. **CommonJS output, not ESM**: Rspack and Webpack both `require()` loaders and plugins. The generated loader runtime also uses `require()` to import the symbol/sprite modules. ESM would break loader resolution.
2. **`this._compilation` for loader-to-plugin communication**: The plugin attaches itself to `compilation[NAMESPACE]` during `thisCompilation`. The loader reads it via `this._compilation[NAMESPACE].addSymbol()`. This is the same pattern `svg-sprite-loader` uses.
3. **`FallbackRawSource`**: The plugin tries `compiler.rspack.sources.RawSource` first (Rspack), then `webpack-sources` (Webpack 5), then a minimal polyfill. This keeps the plugin compatible with both bundlers.
4. **`:target` CSS in extracted sprites**: The generated sprite includes `<style>` with `:target` rules so individual symbols can be previewed in a browser by navigating to `sprite.svg#symbolId`.

## Testing Guidelines

- Each source module has a corresponding test file: `loader.test.ts`, `plugin.test.ts`, `symbol.test.ts`, `browser-sprite.test.ts`.
- Tests mock Rspack/Webpack APIs (compiler, compilation, loader context) rather than running full builds.
- `browser-sprite.test.ts` uses jsdom-style DOM mocking. Call `_reset()` between tests.
- When adding a new loader option, add tests covering both inline and extract mode.
- Coverage must stay above 95%. Run `pnpm test:ci` to check.

## CI/CD Pipeline

The GitHub Actions workflow (`ci.yml`) has four jobs:

1. **lint** — typecheck, eslint, prettier check (runs in parallel with test)
2. **test** — build, run tests with coverage, upload to Codecov
3. **build-examples** — builds both example apps (depends on test)
4. **release** — runs `semantic-release` on pushes to `main` after all other jobs pass. Publishes to npm and creates GitHub releases automatically.

Branch protection on `main` requires PRs with passing CI status checks.

## Pre-Push Checklist

**You MUST run these commands locally and confirm they all pass before pushing or creating a PR.** These mirror the CI pipeline — if they pass locally, CI will pass.

```bash
pnpm typecheck        # TypeScript type checking (no emit)
pnpm lint             # ESLint on src/
pnpm format:check     # Prettier formatting check on ALL files
pnpm test             # Build + run all tests with coverage
```

If `pnpm format:check` fails, run `pnpm format` to auto-fix, then stage the changes before committing.

## Common Tasks

### Adding a new loader option

1. Add the option to the `LoaderOptions` interface in `src/loader.ts`.
2. Handle it in the `svgSpriteLoader` function.
3. Add tests in `src/__tests__/loader.test.ts`.
4. Document in `README.md` under "Loader Options".

### Adding a new plugin option

1. Add to `PluginConfig` interface and `defaultConfig` in `src/plugin.ts`.
2. Handle in the `merge()` function and where applicable in `generateSprite()` or `apply()`.
3. Add tests in `src/__tests__/plugin.test.ts`.
4. Document in `README.md` under "Plugin Options".

### Modifying the sprite output format

The `generateSprite()` method in `src/plugin.ts` is the single source of truth for sprite markup. Changes here affect the extracted `.svg` file structure.

### Updating examples

Both examples use `workspace:*` to reference the local plugin. After changing the plugin, run `pnpm build` from root, then test with `pnpm dev:rspack` or `pnpm dev:webpack`.
